name: "build"

on:
  push:
    branches: ["main", "AWS_ECR"]

jobs:
  build-docker:
    runs-on: "ubuntu-latest"

    env:
      #AWS_REGION: "us-east-2"
      ECR_REGISTRY: "public.ecr.aws/x9a4j9i2"

    steps:
    #- name: "login to AWS"
    #  uses: "aws-actions/configure-aws-credentials@v1"
    #  with:
    #    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #    aws-region: ${{ env.AWS_REGION }}

    - name: "login to ECR"
      uses: "docker/login-action@v1"
      with:
        registry: "public.ecr.aws"
        username: ${{ secrets.AWS_ACCESS_KEY_ID }}
        password: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - uses: "actions/checkout@v2"

    - name: "build"
      run: "docker build -t koinonia ."

    - name: "export"
      run: "docker save koinonia > koinonia.tar"

    - uses: "actions/upload-artifact@v2"
      with:
        name: "docker image"
        path: "koinonia.tar"

    - name: "push to ECR"
      run: "docker tag koinonia $ECR_REGISTRY/koinonia:latest && docker push $ECR_REGISTRY/koinonia:latest"
